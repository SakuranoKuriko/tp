<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>BBS</title>
<link rel="shortcut icon" href="/favicon.ico" />
<link href="/css/common.css" rel="stylesheet" type="text/css">
<script language="javascript" src="/js/vue.js"></script>
<script language="javascript" src="/js/axios.js"></script>
<script language="javascript" src="/js/vars.js"></script>
<style type="text/css">
  body{
    text-align: center;
    width: 100%;
    min-width: 600px;
    margin: 0 auto 40px;
  }
  header{
    text-align: right;
    font-size: 24px;
    color: #000;
    width: 100%;
  }
  a, a:link, a:visited{
    color: #000;
    text-decoration: none;
  }
  a[href]:hover{
    text-decoration: underline;
  }
  a:active{
    color: #666;
  }
  select{
    -webkit-appearance: none;
    appearance: none;
  }
  .blur:after{
    content: '';
    background: inherit;
    width: 100%;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
    filter: blur(5px);
  }
  #main{
    width: 80%;
    margin: 0 auto;
  }
  #headslider{
    height: 300px;
    width: 100%;
    margin: 0 auto;
    position: relative;
    margin-top: 50px;
    overflow: hidden;
    background: #ffe;
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center center;
  }
  #headslider .sliders{
    transition: all 1s;
    -webkit-transition: all 1s;
    position: relative;
    height: 100%;
    width: 100%;
    cursor: pointer;
  }
  #headslider .sliders div{
    position: absolute;
    height: 100%;
    width: 100%;
    background: #ffe;
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center center;
  }
  #headslider .slidersi{
    transition: all 1s;
    -webkit-transition: all 1s;
    position: absolute;
    bottom: 3%;
    left: 0;
    width: 100%;
    height: 15px;
    vertical-align: middle;
    opacity: .4;
    cursor: pointer;
  }
  #headslider .slidersi div{
    position: absolute;
    height: 15px;
    width: 15px;
    bottom: 3%;
    border-radius: 50%;
    box-shadow: 0 0 1px #fff;
    background: #f91;
    transition: all .1s;
    margin-left: 20px;
  }
  #headslider .slidersi div:hover,
  #headslider .slidersi div.nowi{
    -webkit-transform: scale(1.35);
    transform: scale(1.35);
    cursor: default;
  }
  #user{
    position: absolute;
    top: 36px;
    right: 10%;
    width: 140px;
    height: 52px;
    /* font-family: "Microsoft YaHei", "Helvetica", Arial, "sans-serif";
    box-shadow: 0 0 2px 2px #fff; */
    padding: 12px;
    text-align: center;
    background: #fff;
    /*transition: all .1s linear;*/
  }
  #user div{
    width: 80px;
    height: 22px;
    font-size: 16px;
    line-height: 22px;
    cursor: pointer;
    color: #0af;
    transition: all .1s;
    position: absolute;
  }
  #user div:hover{
    color: #6df;
  }
  #user .reg-me,
  #user .login-out{
    top: 18%;
    right: 7%;
  }
  #user .login-out{
    top: 50%;
  }
  #user .me-icon{
    box-shadow: 1px 1px 2px #999;
    background-repeat: no-repeat;
    background-size: 100% 100%;
    margin-left: 4px;
    width: 50px;
    height: 50px;
  }
  #user .reg-me:after{
    content: '注册';
  }
  #user.logged .reg-me:after{
    content: attr(username);
  }
  #user .login-out:after{
    content: '登录';
  }
  #user.logged .login-out:after{
    content: '注销';
  }
  #search{
    margin: 10px auto;
    position: relative;
    height: 40px;
    line-height: 40px;
    font-size: 20px;
  }
  #search .searchstr,
  #search .select,
  #search .ok,
  #newpost{
    position: absolute;
    height: 100%;
    font-size: 16px;
    padding: 0;
    margin: 0;
    z-index: 2;
    transition: all .1s;
  }
  #search .searchstr{
    left: calc(20px + 2%);
    width: 64%;
  }
  #search .searchstr input{
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 100%;
    font-size: inherit;
    box-sizing: border-box;
    border: none;
    padding: 5px 0;
    outline: none;
    background: inherit;
    border-radius: 25%;
    z-index: 2;
  }
  #search .searchstr:hover,
  #search .searchstr.focus{
    background-color: #cff;
  }
  #search .searchstr:before,
  #search .searchstr:after{
    position: absolute;
    content: '';
    border-radius: 50%;
    background-color: inherit;
    height: 40px;
    width: 40px;
    z-index: 1;
  }
  #search .searchstr:before{
    left: -20px;
  }
  #search .searchstr:after{
    right: -20px;
  }
  #search .select{
    left: 52.5%;
    width: 120px;
    margin: 5px 0;
    height: 30px;
    line-height: 30px;
    transition: all .5s;
    -webkit-transition: all .5s;
    transform: rotateX(0);
    -webkit-transform: rotateX(0);
    font-style:italic;
    cursor: pointer;
  }
  #search .select .b-face{
    left: 0;
  }
  #search .select .b-front{
    transform: translateZ(15px);
    -webkit-transform: translateZ(15px);
  }
  #search .select .b-bottom{
    transform: rotateX(-90deg) translateZ(15px);
    -webkit-transform: rotateX(-90deg) translateZ(15px);
  }
  #search .select .b-back{
    transform: rotateX(-180deg) translateZ(15px);
    -webkit-transform: rotateX(-180deg) translateZ(15px);
  }
  #search .ok{
    right: 15%;
    width: 12%;
    cursor: pointer;
    overflow: hidden;
  }
  #search .ok,
  #newpost{
    font-size: 18px;
  }
  #search .ok:hover,
  #newpost:hover{
    background: #cff;
  }
  #newpost{
    width: 12%;
    right: 2%;
    font-size: 20px;
    cursor: pointer;
    overflow: hidden;
  }
  #mainlist{
    width: 100%;
    margin: 0 auto;
  }
  #mainlist #posthead{
    background: #fff;
    font-size: 18px;
  }
  #mainlist .post{
    position: relative;
    height: 40px;
    line-height: 40px;
    font-size: 18px;
    text-align: left;
    background: inherit;
    box-shadow: 0 0 2px #aff;
    margin-top: 10px;
    padding: 0 20px;
    transition: all .1s;
  }
  #mainlist .post:hover{
    background: #aff;
  }
  #mainlist .post .title{
    height: 100%;
  }
  #mainlist .post .my{
    position: absolute;
    width: 0;
    height: 0;
    top: 0;
    right: 0;
    border-top: 15px solid #0af;
    border-left: 15px solid transparent;
  }
  #mainlist .post .postusrinfo{
    position: absolute;
    top: 0;
    right: 20px;
    height: 100%;
    width: 120px;
  }
  #mainlist .post .postusrinfo.own{
    right: 150px;
  }
  #mainlist .post .postusrinfo .usrid,
  #mainlist .post .postusrinfo .time{
    display: block;
  }
  #mainlist .post .postusrinfo .usrid{
    height: 24px;
    line-height: 24px;
    font-size: 14px;
  }
  #mainlist .post .postusrinfo .time{
    height: 12px;
    line-height: 12px;
    font-size: 10px;
    text-decoration: none;
    color: #666;
    pointer-events: none;
  }
  #mainlist .post .postusrinfo .norep{
    height: 40px;
    line-height: 40px;
    color: #666;
    pointer-events: none;
  }
</style>
<script language="javascript">
  var mv;
  var userupdatetimer;
  var cfg = {
    sliderdelay: 5000
  };
  function getid(usrid){
    t = usrid.match(vars.Regexp.getid);
    if (t==null)
      return t;
    else return t[0];
  }
  function getnum(str){
    t = str.match(vars.Regexp.getnum);
    if (t==null)
      return t;
    else return parseInt(t[0]);
  }
</script>
</head>
<body>
  <div id="main">
    <header>
    </header>
    <div id="headslider" @mouseover="stopslide();" @mouseleave="startslide();">
      <div v-if="needslider" class="sliders" :data-sliderindex="sliders.now" :style="'transform: translateX(-'+sliders.now*100+'%);'">
        <div v-for="(v,i) in sliders.lst" :id="'sliders'+v" :data-sliderindex="i" :style="'background-image:url('+v.img+');left: calc(100% * '+i+');'" @click="location.href=v.url;"></div>
      </div>
      <div v-if="needslider" class="slidersi">
        <div v-for="(v,i) in sliders.lst" :data-sliderindex="i" :class="sliders.now==i?'nowi':''" :style="'left: calc(24px * '+i+');'" @mouseover="sliders.now=i;"></div>
      </div>
      <div id="user" :class="user.logged?'logged':''">
        <div class="me-icon" :style="'background-image: url('+(user.logged?user.icon:user.noicon)+');'"></div>
        <div class="reg-me ellipsis" :username="user.name"></div>
        <div class="login-out"></div>
      </div>
    </div>
    <div id="toolbar">
      <div id="search">
        <div class="searchstr" :class="search.focus?'focus':''">
          <input type="text" placeholder="搜索..." @focus="search.focus=true" @blur="search.focus=false"/>
        </div>
        <div class="select b-box" :style="'transform:rotateX('+search.mode*90+'deg);'" @click="searchmode();">
          <div class="b-face b-front beforestr" str="搜索标题"></div>
          <div class="b-face b-bottom beforestr" str="搜索标题和内容"></div>
          <div class="b-face b-back beforestr" str="搜索用户"></div>
        </div>
        <div class="ok beforestr" str="搜索"></div>
        <div id="newpost" class="beforestr" str="发帖"></div>
      </div>
    </div>
    <div id="mainlist">
      <div id="posthead" class="post">
        <span class="title">标题</span>
        <span class="postusrinfo own">创建</span>
        <span class="postusrinfo lastrep">最新回复</span>
      </div>
      <div v-if="userupdated" v-for="v in postlst" :id="v.id" class="post" v-cloak>
        <div v-if="chkmy(v)" class="my"></div>
        <a :href="v.url" class="title ellipsis">{{v.ti}}</a>
        <div class="postusrinfo own">
          <a class="usrid ellipsis" :href="'/user/'+users['u'+v.own].usrid">{{users['u'+v.own].name}}</a>
          <a class="time">{{v.createtime}}</a>
        </div>
        <div v-if="v.lastrep!=null" class="postusrinfo lastrep">
          <a class="usrid ellipsis" :href="'/user/'+users['u'+v.lastrep].usrid">{{users['u'+v.lsatrep].name}}</a>
          <a class="time">{{v.updatetime}}</a>
        </div>
        <div v-else class="postusrinfo lastrep">
          <a class="norep">暂无回复</a>
        </div>
      </div>
    </div>
  </div>
  <script language="javascript">
    mv = new Vue({
      el: "#main",
      data: {
        user: {
          logged: false,
          icon: "",
          noicon: "/img/noicon.png",
          name: "Noname",
          uid: 0,
          id: "",
          usrid: "",
          permission: vars.Permission.read,
          usrgroup: vars.UserGroup.guest
        },
        userupdated: false,
        needslider: true,
        sliders: {
          now: 0,
          timerid: 0,
          lst: []
        },
        search: {
          focus: false,
          mode: 0
        },
        postlst: {},
        users: {}
      },
      methods: {
        nextslider: function(){
          mv.sliders.now = (mv.sliders.now+1)%mv.sliders.lst.length;
        },
        startslide: function(){
          mv.sliders.timerid = setInterval(mv.nextslider, cfg.sliderdelay);
        },
        stopslide: function(){
          clearInterval(mv.sliders.timerid);
        },
        searchmode: function(){
          mv.search.mode=(mv.search.mode+1)%3;
          document.querySelector("#search input").focus();
        },
        chkmy: function(post){
          if (post.own==mv.user.uid)
            return true;
          return false;
        },
        getuid: function(usrid){
          u = Object.keys(mv.users);
          for (i in u){
            if (mv.users[u].usrid==usrid)
              return i;
          }
        },
        getusrdata: function(uid, key){
          u = Object.keys(mv.users);
          ui = u.indexOf('u'+uid);
          if (ui!==-1)
            return mv.users[u[ui]][key];
          return "";
        }
      },
      directives: {
      }
    });
    function updateuser(usr){
      if (usr==null||usr=="")
      return;
      axios.get('/user/'+usr+'/json')
           .then(function(res){
              user = res.data;
              user.uid = 'u'+user.id;
              mv.users['u'+user.id] = Object.assign({}, user);
              if (userupdatetimer!=-1)
                clearTimeout(userupdatetimer);
              userupdatetimer = setTimeout(function(){
                console.log("updated");
                mv.userupdated = true;
              },200);
          });
    }
    var i0={$sliders};
    var i1={$postlist};
    var o0=[];
    for (i in i0){
      o0.push({id: i0[i].id, img: i0[i].val1, url: i0[i].val2});
    }
    mv.sliders.lst = Object.assign([], o0);
    var o1={};
    var fid;
    var usrlst = [];
    for (i in i1){
      fid = 'f'+i;
      o1[fid] = i1[i];
      o1[fid].url = '/post/'+i1[i].id;
      o1[fid].id = fid;
      o1[fid].ti = i1[i].title;
      if (usrlst.indexOf(i1[i].own)===-1)
        usrlst.push(i1[i].own);
      if (i1[i].lastrep!=null&&usrlst.indexOf(i1[i].lastrep)===-1)
        usrlst.push(i1[i].lastrep);
    }
    for (i in usrlst){
      updateuser(usrlst[i]);
    }
    mv.postlst = Object.assign({}, o1);
    mv.startslide();
  </script>
</body>
</html>

